<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Local Time Adjustment</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootswatch/4.5.2/darkly/bootstrap.min.css" integrity="sha384-nNK9n28pDUDDgIiIqZ/MiyO3F4/9vsMtReZK39klb/MtkZI3/LtjSjlmyVPS3KdN" crossorigin="anonymous">
        <link rel="stylesheet" href="css/custom.css">
    </head>
    <body>
        <div class="container-fluid h-100">
            <div class="row justify-content-md-center">
                <div class="col-md-auto">
                    <button type="button" id="AMPM_toggle" class="btn btn-primary btn-lg btn-block">24 Hour / AM-PM</button>
                </div>
                <div class="col-md-auto">
                    <div class="btn-group btn-group-toggle" data-toggle="buttons">
                        <label class="btn btn-primary">
                        <input type="radio" name="dose_option" id="6doses" autocomplete="off" checked="" wtx-context="1587E9B6-6C62-47ED-82B8-FAEBFCE91D8E"> 6 Doses Per Vial
                        </label>
                        <label class="btn btn-primary">
                        <input type="radio" name="dose_option" id="8doses" autocomplete="off" wtx-context="568F06A4-EE71-4A27-A780-4EABFF515079"> 8 Doses Per Vial
                        </label>
                        <label class="btn btn-primary active">
                        <input type="radio" name="dose_option" id="11doses" autocomplete="off" wtx-context="16DCA738-6103-4687-A1CC-AD75003E98F6"> 11 Doses Per Vial
                        </label>
                    </div>
                </div>
                <div class="col-md-auto">
                    <div class="btn-group btn-group-toggle" data-toggle="buttons">
                        <label class="btn btn-primary">
                        <input type="radio" name="time_option" id="15minutes" autocomplete="off" checked="" wtx-context="1587E9B6-6C62-47ED-82B8-FAEBFCE91D8E"> 15 Minutes
                        </label>
                        <label class="btn btn-primary">
                        <input type="radio" name="time_option" id="6hours" autocomplete="off" wtx-context="568F06A4-EE71-4A27-A780-4EABFF515079"> 6 Hours
                        </label>
                    </div>
                </div>
                <div class="col-md-auto">
                    <button type="button" id="data_resst" class="btn btn-primary btn-lg btn-block">Reset</button>
                </div>
            </div>
            <div class="row justify-content-md-center">
                <div class="col-md-auto">
                    <h4 class="text-center"> Current Time:</h4>
                    <h2 id="current_time" class="text-center">Current Time</h2>
                </div>
            </div>
            <div class="row justify-content-md-center jumbotron">
                <div class="col-md-auto">
                    <h4 class="text-center"> +15 Minutes:</h4>
                    <h1 id="future_time" class="display-1 text-center">Future Time</h2>
                </div>
            </div>
            <div id="click_to_count" class="row justify-content-center flex-grow-1 h-25">
                <div id="click_text" class="text-white row justify-content-center">CLICK TO COUNT</div>
                <div class="row justify-content-center">
                    <ol id="count">
                    </ol>
                </div>
            </div>
            <div class="row justify-content-center flex-grow-1">
                <h2 id="number" class="text-success"></h2>
            </div>
        </div>
        
        
        
        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment-with-locales.min.js" integrity="sha512-LGXaggshOkD/at6PFNcp2V2unf9LzFq6LE+sChH7ceMTDP0g2kn6Vxwgg7wkPP7AAtX+lmPqPdxB47A0Nz0cMQ==" crossorigin="anonymous"></script>
        
        <script>

            var adjustment_minutes = 15;
            var AMPM = false;
            var count = 0;
            var doses = 6;

            var add_minutes =  function (dt, minutes) {
                return new Date(dt.getTime() + minutes*60000);
            }

            function saveDetails(){
                var details = {
                    count: count,
                    ampm: AMPM,
                    adjustment: adjustment_minutes,
                    doses: doses,
                }

                window.localStorage.setItem('time_counter', JSON.stringify(details));
            }

            function getDetails(){
                var details = JSON.parse(window.localStorage.getItem('time_counter'));
                console.log(details);
                adjustment_minutes = details.adjustment;
                AMPM = details.ampm;
                count = details.count;
                doses = details.doses;
                if (count > 0){
                    $("#click_text").hide();
                    $("#number").text(count);
                    var i = 0;
                    while (i < count){
                        addTally();
                        i = i + 1;
                    }

                }
                if (doses == 6){
                    $("#6doses").prop("checked", true);
                } else if (doses == 8){
                    $("#8doses").prop("checked", true);
                } else if (doses == 11){
                    $("#11doses").prop("checked", true);
                }
                if (adjustment_minutes == 15){
                    $("#15minutes").prop("checked", true);
                } else if (adjustment_minutes == 6*60){
                    $("#6hours").prop("checked", true);
                }
            }

            function toggleAMPM(){
                if (AMPM){
                    AMPM = false;
                } else {
                    AMPM = true;
                }
            }

            function timeSelect(){

            }

            function doseSelect(){
                
            }

            function updateTimes(){
                var time_format = 'HH:mm:ss';
                var future_time_format = 'HH:mm';
                if (AMPM) {
                    time_format = 'hh:mm:ss A';
                    future_time_format = 'hh:mm A';
                }
                var time_now = moment().format(time_format);
                var time_future = moment().add(adjustment_minutes, 'm').add(30, 'seconds').startOf('minute').format(future_time_format);
                $("#current_time").text(time_now);
                $("#future_time").text(time_future);
                //console.log(time_now)
            }

            function addTally(){
                $('<li />').prop('class','tally').appendTo('#count');
                    return false;
            }

            function addCount(){
                count = count + 1;
                console.log(count)
                var dose_check = count % doses;

                if(dose_check === 0){
                    $("#number").addClass('text-warning');
                    $("#number").removeClass('text-sucess');
                }
                else{
                    $("#number").removeClass('text-warning');
                    $("#number").addClass('text-success');
                }
                $("#number").text(count);
            }


            $("#AMPM_toggle").click( function(){
                toggleAMPM();
                saveDetails();
            });

            $("#click_to_count").click( function(){  
                addTally();
                addCount();
                $("#click_text").hide();
                saveDetails();
            });

            $("input[@name='time_option']").change(function(){
                if (this.value == '6hours') {
                    adjustment_minutes = 6*60;
                } else if (this.value == '15minutes'){
                    adjustment_minutes = 15;
                }
                saveDetails();
            });

            $("input[@name='dose_option']").change(function(){
                if (this.value == '6doses') {
                    doses = 6;
                } else if (this.value == '8doses'){
                    doses = 8;
                } else if (this.value == '11doses'){
                    doses = 11;
                }
                saveDetails();
            });

            $( document ).ready(function() {
                
                getDetails();
                updateTimes();
                setInterval(updateTimes, 500);
            });
        </script>
    </body>
</html>